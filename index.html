<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>草履蟲模擬 - 完整版</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    canvas {
      display: block;
    }
    .controls {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #f0f0f0;
      padding: 10px 0;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      z-index: 10;
    }
    .controls button {
      margin: 6px;
      padding: 15px 20px;
      font-size: 16px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
<canvas id="canvas"></canvas>

<div class="controls">
  <button onclick="setLight(true)">有光</button>
  <button onclick="setLight(false)">無光</button>
  <button onclick="setSaltLevel(0)">鹽水 0%</button>
  <button onclick="setSaltLevel(0.5)">鹽水 0.5%</button>
  <button onclick="setSaltLevel(1)">鹽水 1%</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let width, height;
let paramecia = [];
let predators = [];
let foodSources = [];
let lightOn = true;
let saltLevel = 0;

function resize() {
  width = canvas.width = window.innerWidth;
  height = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

class Paramecium {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.energy = 100;
    this.age = 0;
    this.lifespan = 1500 + Math.random() * 500;
    this.vx = Math.random() * 2 - 1;
    this.vy = Math.random() * 2 - 1;
  }

  update() {
    this.age += 1 + saltLevel * 0.5;
    this.energy -= 0.05 + saltLevel * 0.1;

    // 向光移動（感光行為）
    if (lightOn) {
      let dx = 0 - this.x;
      let dy = 0 - this.y;
      let mag = Math.sqrt(dx * dx + dy * dy);
      if (mag > 1) {
        this.vx += dx / mag * 0.02;
        this.vy += dy / mag * 0.02;
      }
    } else {
      this.vx += Math.random() * 0.2 - 0.1;
      this.vy += Math.random() * 0.2 - 0.1;
    }

    // 鹽水影響移動速度
    let slow = 1 - saltLevel * 0.3;
    this.vx *= slow;
    this.vy *= slow;

    this.x += this.vx;
    this.y += this.vy;

    if (this.x < 0 || this.x > width) this.vx *= -1;
    if (this.y < 0 || this.y > height) this.vy *= -1;

    // 吃食物
    for (let i = 0; i < foodSources.length; i++) {
      const food = foodSources[i];
      const dx = this.x - food.x;
      const dy = this.y - food.y;
      if (Math.sqrt(dx*dx + dy*dy) < 10) {
        this.energy = Math.min(this.energy + 20, 100);
        foodSources.splice(i, 1);
        break;
      }
    }
  }

  draw() {
    ctx.fillStyle = lightOn ? `rgb(${50 + this.energy*2}, ${200}, ${255})` : '#00FFAA';
    ctx.beginPath();
    ctx.arc(this.x, this.y, 6, 0, Math.PI * 2);
    ctx.fill();

    // 顯示能量數字
    ctx.fillStyle = lightOn ? 'black' : 'white';
    ctx.font = "12px sans-serif";
    ctx.fillText(Math.round(this.energy), this.x - 10, this.y - 10);
  }

  isDead() {
    return this.energy <= 0 || this.age > this.lifespan;
  }
}

class Predator {
  constructor() {
    this.x = Math.random() * width;
    this.y = Math.random() * height;
    this.energy = 100;
  }

  update() {
    if (paramecia.length === 0) return;

    // 找最近草履蟲
    let target = null;
    let minDist = Infinity;
    for (let p of paramecia) {
      let dx = this.x - p.x;
      let dy = this.y - p.y;
      let dist = dx*dx + dy*dy;
      if (dist < minDist) {
        minDist = dist;
        target = p;
      }
    }

    if (target) {
      let dx = target.x - this.x;
      let dy = target.y - this.y;
      let mag = Math.sqrt(dx*dx + dy*dy);
      this.x += dx / mag * 1.5;
      this.y += dy / mag * 1.5;

      // 吃掉草履蟲
      if (mag < 10) {
        this.energy = Math.min(this.energy + 50, 100);
        paramecia.splice(paramecia.indexOf(target), 1);
      }
    }
  }

  draw() {
    ctx.fillStyle = 'red';
    ctx.beginPath();
    ctx.arc(this.x, this.y, 10, 0, Math.PI * 2);
    ctx.fill();
  }
}

class Food {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }
  draw() {
    ctx.fillStyle = 'green';
    ctx.beginPath();
    ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
    ctx.fill();
  }
}

function setLight(on) {
  lightOn = on;
}

function setSaltLevel(level) {
  saltLevel = level;
}

function generateFood() {
  if (Math.random() < 0.02) {
    foodSources.push(new Food(Math.random() * width, Math.random() * height));
  }
}

function loop() {
  ctx.fillStyle = lightOn ? '#FFFFFF' : '#000000';
  ctx.fillRect(0, 0, width, height);

  generateFood();

  for (let i = paramecia.length - 1; i >= 0; i--) {
    const p = paramecia[i];
    p.update();
    p.draw();

    // 繁殖
    if (p.energy > 90 && Math.random() < 0.002) {
      paramecia.push(new Paramecium(p.x + Math.random()*10 - 5, p.y + Math.random()*10 - 5));
      p.energy -= 30;
    }

    if (p.isDead()) {
      paramecia.splice(i, 1);
    }
  }

  for (let predator of predators) {
    predator.update();
    predator.draw();
  }

  for (let food of foodSources) {
    food.draw();
  }

  requestAnimationFrame(loop);
}

// 初始化
for (let i = 0; i < 10; i++) {
  paramecia.push(new Paramecium(Math.random() * width, Math.random() * height));
}
for (let i = 0; i < 2; i++) {
  predators.push(new Predator());
}

loop();
</script>
</body>
</html>
